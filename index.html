<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>網路通訊期末模擬試題</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      /* 基礎色票 (Light Mode Default) */
      --primary: #2563eb;
      --primary-fg: #ffffff;
      --secondary: #64748b;
      --success: #22c55e;
      --danger: #ef4444;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --bg-sub: #f1f5f9;
      /* 統計框背景 */
      --bg-hover: #eff6ff;
      /* 選項懸浮/選中背景 */
      --bg-danger-light: #fef2f2;
      /* 錯誤提示背景 */
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* 深色模式 (Dark Mode) */
    @media (prefers-color-scheme: dark) {
      :root {
        --primary: #60a5fa;
        --primary-fg: #0f172a;
        --secondary: #94a3b8;
        --success: #4ade80;
        --danger: #f87171;
        --bg: #0f172a;
        --card: #1e293b;
        --text: #f1f5f9;
        --text-muted: #94a3b8;
        --border: #334155;
        --bg-sub: #334155;
        --bg-hover: #1e3a8a;
        --bg-danger-light: rgba(239, 68, 68, 0.15);
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
      }
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      line-height: 1.6;
      transition: background-color 0.3s, color 0.3s;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }

    h1,
    h2,
    h3 {
      margin-top: 0;
      color: var(--text);
    }

    .btn {
      background-color: var(--primary);
      color: var(--primary-fg);
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: opacity 0.2s;
      font-weight: 600;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .btn-danger {
      background-color: var(--danger);
      color: white;
    }

    .timer {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--danger);
      text-align: right;
      margin-bottom: 10px;
    }

    .question-block {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .options-grid {
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }

    .option-label {
      display: block;
      padding: 10px;
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text);
    }

    /* .option-label:hover { border-color: var(--primary); } */
    input[type="radio"]:checked+.option-label {
      border-color: var(--primary);
      background-color: var(--bg-hover);
      font-weight: bold;
    }

    input[type="radio"] {
      display: none;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
      text-align: center;
    }

    .stat-box {
      background: var(--bg-sub);
      padding: 15px;
      border-radius: 8px;
    }

    .stat-val {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
    }

    .review-item {
      border-left: 4px solid var(--danger);
      padding-left: 15px;
      margin-bottom: 20px;
      background: var(--bg-danger-light);
      padding: 15px;
      border-radius: 0 8px 8px 0;
    }

    .correct-ans {
      color: var(--success);
      font-weight: bold;
    }

    .wrong-ans {
      color: var(--danger);
      text-decoration: line-through;
    }

    .explanation {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px dashed var(--secondary);
      font-size: 0.9em;
      color: var(--text-muted);
    }

    .view {
      display: none;
    }

    .active-view {
      display: block;
    }
  </style>
</head>

<body>

  <div class="container">
    <div id="view-dashboard" class="view active-view">
      <div class="card">
        <h1>網路通訊期末模擬試題</h1>
        <p>資料庫共收錄 <span id="total-pool-size">0</span> 題。每次隨機測驗 20 題。</p>
        <div style="margin-bottom: 20px;">
          <div style="display:flex; justify-content:space-between; font-size:0.9rem; color:var(--text-muted);">
            <span>題庫覆蓋率 (完成一輪自動重置)</span>
            <span id="coverage-text">0%</span>
          </div>
          <div
            style="width: 100%; height: 10px; background-color: var(--border); border-radius: 5px; margin-top: 5px; overflow: hidden;">
            <div id="coverage-bar"
              style="height: 100%; background-color: var(--success); width: 0%; transition: width 0.3s;"></div>
          </div>
        </div>
        <div class="stat-grid">
          <div class="stat-box">
            <div>歷史平均分</div>
            <div class="stat-val" id="avg-score">--</div>
          </div>
          <div class="stat-box">
            <div>總正確率</div>
            <div class="stat-val" id="total-accuracy">--%</div>
          </div>
          <div class="stat-box">
            <div>累積錯題數</div>
            <div class="stat-val" id="total-wrong-count">0</div>
          </div>
        </div>
        <button class="btn" onclick="window.startQuiz()">開始測驗 (20題)</button>
        <button class="btn btn-danger" onclick="window.clearData()" style="float: right;">清除紀錄</button>
      </div>
      <div class="card">
        <h3>成績走勢圖</h3>
        <canvas id="scoreChart"></canvas>
      </div>
      <div class="card">
        <h3>歷史錯題庫 (最近 50 筆)</h3>
        <div id="wrong-history-list" style="max-height: 300px; overflow-y: auto;"></div>
      </div>
    </div>
    <div id="view-quiz" class="view">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h2>測驗進行中</h2>
          <div class="timer" id="timer">15:00</div>
        </div>
        <div id="quiz-container"></div>
        <button class="btn" onclick="window.submitQuiz()">送出試卷</button>
      </div>
    </div>

    <div id="view-result" class="view">
      <div class="card">
        <h2>本次測驗結果</h2>
        <div class="stat-grid">
          <div class="stat-box">
            <div>得分</div>
            <div class="stat-val" id="result-score">0</div>
          </div>
          <div class="stat-box">
            <div>正確率</div>
            <div class="stat-val" id="result-accuracy">0%</div>
          </div>
          <div class="stat-box">
            <div>耗時</div>
            <div class="stat-val" id="result-time">00:00</div>
          </div>
        </div>
        <button class="btn" onclick="window.showDashboard()">返回主頁</button>
      </div>
      <div class="card">
        <h3>錯題檢討</h3>
        <div id="review-container"></div>
      </div>
    </div>
  </div>

  <script>
    // --- 0. THEME HELPER ---
    function getThemeColor() { return (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? '#f1f5f9' : '#1e293b'; }
    function getGridColor() { return (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? '#334155' : '#e2e8f0'; }

    // --- 1. DATA LOADING ---
    const filename = "/network-quiz_pool.json";
    let questionPool = [];

    async function loadQuestions() {
      try {
        const response = await fetch(`${filename}`);
        if (!response.ok) throw new Error('Network response was not ok');
        const rawData = await response.json();
        questionPool = rawData.map(item => ({
          id: item.id, q: item.question, a: item.ans, o: item.option, explanation: item.detail
        }));
        initDashboard();
      } catch (error) {
        console.error('Error:', error);
        alert('讀取失敗，請檢查 console 或確認是否使用 Web Server 執行。');
      }
    }

    // --- 2. APP STATE & CONFIG ---
    let currentQuestions = [];
    let userAnswers = {};
    let timerInterval;
    let timeElapsed = 0;

    // 權重演算法參數
    const DEFAULT_WEIGHT = 10;
    const WEIGHT_INC_WRONG = 10;
    const WEIGHT_DEC_CORRECT = 2;
    const MIN_WEIGHT = 1;

    // --- 3. STORAGE UTILS (Enhanced) ---
    function getHistory() { try { return JSON.parse(localStorage.getItem('quiz_history') || '[]'); } catch { return []; } }
    function saveHistory(record) { const h = getHistory(); h.push(record); localStorage.setItem('quiz_history', JSON.stringify(h)); }

    function getWrongHistory() { try { return JSON.parse(localStorage.getItem('quiz_wrong_qs') || '{}'); } catch { return {}; } }
    function saveWrongHistory(wrongIds) {
      const w = getWrongHistory();
      wrongIds.forEach(id => { w[id] = (w[id] || 0) + 1; });
      localStorage.setItem('quiz_wrong_qs', JSON.stringify(w));
    }

    // [新增] 權重與已讀紀錄
    function getWeights() { try { return JSON.parse(localStorage.getItem('quiz_weights') || '{}'); } catch { return {}; } }
    function saveWeights(weights) { localStorage.setItem('quiz_weights', JSON.stringify(weights)); }
    function getSeenIds() { try { return JSON.parse(localStorage.getItem('quiz_seen_ids') || '[]'); } catch { return []; } }
    function saveSeenIds(ids) { localStorage.setItem('quiz_seen_ids', JSON.stringify(ids)); }

    // --- 4. CORE LOGIC ---
    window.showView = function (viewId) {
      document.querySelectorAll('.view').forEach(el => el.classList.remove('active-view'));
      document.getElementById(viewId).classList.add('active-view');
      if (viewId === 'view-dashboard') initDashboard();
    }

    // [修改] 啟動測驗：改為權重演算法
    window.startQuiz = function () {
      if (questionPool.length === 0) { alert("題庫載入中或為空"); return; }

      let seenIds = getSeenIds();
      // 若全數做完，重置進度
      if (seenIds.length >= questionPool.length) {
        alert("恭喜！你已經完成了一輪所有題目。系統將重置進度，開啟新的一輪刷題！");
        seenIds = [];
        saveSeenIds([]);
      }

      const weights = getWeights();
      const unseenPool = questionPool.filter(q => !seenIds.includes(q.id));
      const seenPool = questionPool.filter(q => seenIds.includes(q.id));

      const TOTAL_Q = 20;
      const TARGET_UNSEEN = 14;
      let selectedQuestions = [];

      // 1. 優先選未做過的
      const shuffledUnseen = [...unseenPool].sort(() => 0.5 - Math.random());
      const takeUnseenCount = Math.min(TARGET_UNSEEN, shuffledUnseen.length);
      selectedQuestions = selectedQuestions.concat(shuffledUnseen.slice(0, takeUnseenCount));

      // 2. 剩餘名額用權重選已做過的
      const slotsRemaining = TOTAL_Q - selectedQuestions.length;
      if (slotsRemaining > 0) {
        if (seenPool.length > 0) {
          selectedQuestions = selectedQuestions.concat(pickWeightedQuestions(seenPool, weights, slotsRemaining));
        } else {
          // 若沒做過的題目很多，補未做過的
          selectedQuestions = selectedQuestions.concat(shuffledUnseen.slice(takeUnseenCount, takeUnseenCount + slotsRemaining));
        }
      }

      currentQuestions = selectedQuestions.sort(() => 0.5 - Math.random());
      userAnswers = {};
      renderQuiz();
      startTimer();
      window.showView('view-quiz');
    }

    // [新增] 加權隨機抽取函數
    function pickWeightedQuestions(pool, weightMap, count) {
      let candidates = [...pool];
      let selected = [];
      for (let i = 0; i < count; i++) {
        if (candidates.length === 0) break;
        let totalWeight = 0;
        candidates.forEach(q => totalWeight += (weightMap[q.id] || DEFAULT_WEIGHT));
        let randomVal = Math.random() * totalWeight;
        let currentSum = 0;
        for (let j = 0; j < candidates.length; j++) {
          const w = weightMap[candidates[j].id] || DEFAULT_WEIGHT;
          currentSum += w;
          if (currentSum >= randomVal) {
            selected.push(candidates[j]);
            candidates.splice(j, 1);
            break;
          }
        }
      }
      return selected;
    }

    // [修改] 送出試卷：更新權重與進度
    window.submitQuiz = function () {
      clearInterval(timerInterval);
      let correctCount = 0;
      let wrongIds = [];
      let seenIds = getSeenIds();
      let weights = getWeights();

      const currentIds = currentQuestions.map(q => q.id);
      seenIds = [...new Set([...seenIds, ...currentIds])]; // 更新已看過的題目
      saveSeenIds(seenIds);

      currentQuestions.forEach(q => {
        const currentW = weights[q.id] || DEFAULT_WEIGHT;
        if (userAnswers[q.id] === q.a) {
          correctCount++;
          // 答對減權重 (最少為1)
          weights[q.id] = Math.max(MIN_WEIGHT, currentW - WEIGHT_DEC_CORRECT);
        } else {
          wrongIds.push(q.id);
          // 答錯加權重
          weights[q.id] = currentW + WEIGHT_INC_WRONG;
        }
      });

      saveWeights(weights); // 儲存權重

      const score = correctCount * 5;
      const accuracy = (currentQuestions.length > 0) ? (correctCount / currentQuestions.length * 100).toFixed(0) : 0;

      saveHistory({ date: new Date().toISOString(), score: score, correctCount: correctCount, timeSeconds: timeElapsed });
      saveWrongHistory(wrongIds);

      document.getElementById('result-score').innerText = score;
      document.getElementById('result-accuracy').innerText = accuracy + '%';

      const m = Math.floor(timeElapsed / 60).toString().padStart(2, '0');
      const s = (timeElapsed % 60).toString().padStart(2, '0');
      document.getElementById('result-time').innerText = `${m}:${s}`;

      renderReview(wrongIds);
      window.showView('view-result');
    }

    window.showDashboard = function () { initDashboard(); window.showView('view-dashboard'); }

    // [修改] 清除所有資料
    window.clearData = function () {
      if (confirm('確定要清除所有歷史紀錄、權重與進度嗎？')) {
        localStorage.removeItem('quiz_history');
        localStorage.removeItem('quiz_wrong_qs');
        localStorage.removeItem('quiz_weights'); // 新增
        localStorage.removeItem('quiz_seen_ids'); // 新增
        initDashboard();
      }
    }

    // --- 5. RENDER HELPERS ---
    function renderQuiz() {
      const container = document.getElementById('quiz-container');
      container.innerHTML = '';
      currentQuestions.forEach((q, idx) => {
        const opts = Object.keys(q.o).sort();
        const block = document.createElement('div');
        block.className = 'question-block';
        block.innerHTML = `
                <div style="font-weight:bold; margin-bottom:10px;">${idx + 1}. ${q.q}</div>
                <div class="options-grid">
                    ${opts.map(opt => `
                        <div>
                            <input type="radio" name="q-${q.id}" id="q-${q.id}-${opt}" value="${opt}" onchange="recordAnswer(${q.id}, '${opt}')">
                            <label class="option-label" for="q-${q.id}-${opt}"><strong>(${opt})</strong> ${q.o[opt]}</label>
                        </div>
                    `).join('')}
                </div>`;
        container.appendChild(block);
      });
    }

    window.recordAnswer = function (qId, val) { userAnswers[qId] = val; }

    function startTimer() {
      timeElapsed = 0;
      clearInterval(timerInterval);
      const timerEl = document.getElementById('timer');
      timerInterval = setInterval(() => {
        timeElapsed++;
        const m = Math.floor(timeElapsed / 60).toString().padStart(2, '0');
        const s = (timeElapsed % 60).toString().padStart(2, '0');
        timerEl.innerText = `${m}:${s}`;
      }, 1000);
    }

    function renderReview(wrongIds) {
      const container = document.getElementById('review-container');
      container.innerHTML = '';
      if (wrongIds.length === 0) {
        container.innerHTML = '<p style="color:var(--success); font-weight:bold;">本次全對！</p>';
        return;
      }
      wrongIds.forEach(id => {
        const q = currentQuestions.find(item => item.id === id);
        const userAns = userAnswers[id] || '未作答';
        const div = document.createElement('div');
        div.className = 'review-item';
        div.innerHTML = `
                <div><strong>題目:</strong> ${q.q}</div>
                <div style="margin-top:5px;">
                    <span class="wrong-ans">您的答案: ${userAns}</span> | 
                    <span class="correct-ans">正確答案: ${q.a}</span>
                </div>
                ${q.explanation ? `<div class="explanation"><strong>詳解:</strong> ${q.explanation}</div>` : ''}
            `;
        container.appendChild(div);
      });
    }

    // [修改] 初始化儀表板：增加進度條計算
    function initDashboard() {
      const poolLen = questionPool.length;
      document.getElementById('total-pool-size').innerText = poolLen;

      const history = getHistory();
      const wrongStore = getWrongHistory();
      const seenIds = getSeenIds(); // 新增

      // 更新進度條 UI
      const coveragePct = poolLen > 0 ? ((seenIds.length / poolLen) * 100).toFixed(1) : 0;
      const barEl = document.getElementById('coverage-bar');
      const textEl = document.getElementById('coverage-text');
      if (barEl) barEl.style.width = `${coveragePct}%`;
      if (textEl) textEl.innerText = `${seenIds.length} / ${poolLen} (${coveragePct}%)`;

      if (history.length > 0) {
        const totalScore = history.reduce((acc, cur) => acc + cur.score, 0);
        const accuracy = ((history.reduce((acc, cur) => acc + cur.correctCount, 0) / (history.length * 20)) * 100).toFixed(1);
        document.getElementById('avg-score').innerText = (totalScore / history.length).toFixed(1);
        document.getElementById('total-accuracy').innerText = accuracy + '%';
      } else {
        document.getElementById('avg-score').innerText = '--';
        document.getElementById('total-accuracy').innerText = '--%';
      }
      document.getElementById('total-wrong-count').innerText = Object.keys(wrongStore).length;

      renderChart(history);
      renderWrongList(wrongStore);
    }

    function renderChart(history) {
      const ctx = document.getElementById('scoreChart').getContext('2d');
      const textColor = getThemeColor();
      const gridColor = getGridColor();

      if (window.myChart) window.myChart.destroy();

      Chart.defaults.color = textColor;
      Chart.defaults.borderColor = gridColor;

      window.myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: history.map((_, i) => `測驗 ${i + 1}`),
          datasets: [{
            label: '得分',
            data: history.map(h => h.score),
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37, 99, 235, 0.1)',
            tension: 0.1,
            fill: true
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, max: 100, grid: { color: gridColor } },
            x: { grid: { color: gridColor } }
          },
          plugins: { legend: { labels: { color: textColor } } }
        }
      });
    }

    function renderWrongList(wrongStore) {
      const listEl = document.getElementById('wrong-history-list');
      listEl.innerHTML = '';
      const sortedIds = Object.keys(wrongStore).sort((a, b) => wrongStore[b] - wrongStore[a]);
      if (sortedIds.length === 0) {
        listEl.innerHTML = '<p style="color:var(--text-muted)">目前沒有錯題紀錄。</p>';
        return;
      }
      sortedIds.slice(0, 50).forEach(id => {
        const q = questionPool.find(item => item.id == id);
        if (!q) return;
        const div = document.createElement('div');
        div.className = 'review-item';
        div.innerHTML = `
                <div><strong>[題號 ${q.id}]</strong> (錯誤次數: ${wrongStore[id]})</div>
                <div style="margin:5px 0;">${q.q}</div>
                <div class="correct-ans">正確答案: ${q.a} (${q.o[q.a]})</div>
                <div class="explanation">知識點: ${q.explanation || '無'}</div>
            `;
        listEl.appendChild(div);
      });
    }

    // Watch for theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', initDashboard);

    // Init on Load
    loadQuestions();
  </script>
</body>

</html>
